name: Commons C++ Build

on:
  push:
    paths:
      - 'sdk/runanywhere-commons/**'
      - '.github/workflows/commons-build.yml'
    branches: [main]
  pull_request:
    paths:
      - 'sdk/runanywhere-commons/**'
      - '.github/workflows/commons-build.yml'
  workflow_dispatch:

env:
  NDK_VERSION: "27.0.12077973"
  CMAKE_VERSION: "3.22"

jobs:
  android:
    name: Android (${{ matrix.abi }})
    runs-on: ubuntu-latest
    timeout-minutes: 60
    strategy:
      fail-fast: false
      matrix:
        abi: [arm64-v8a, armeabi-v7a, x86_64]
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install build tools
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq cmake ninja-build zip

      - name: Setup Android NDK
        run: |
          ANDROID_HOME="${ANDROID_HOME:-$HOME/android-sdk}"
          SDKMANAGER="$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager"
          if [ -f "$SDKMANAGER" ]; then
            yes | "$SDKMANAGER" "ndk;$NDK_VERSION" || true
          fi
          NDK_PATH="$ANDROID_HOME/ndk/$NDK_VERSION"
          if [ ! -d "$NDK_PATH" ]; then
            echo "::error::NDK $NDK_VERSION not found at $NDK_PATH"
            exit 1
          fi
          echo "ANDROID_NDK_HOME=$NDK_PATH" >> $GITHUB_ENV
          echo "NDK found at $NDK_PATH"

      - name: Build commons for ${{ matrix.abi }}
        working-directory: sdk/runanywhere-commons
        run: |
          ./scripts/build-android.sh commons ${{ matrix.abi }}

      - name: Verify build output
        working-directory: sdk/runanywhere-commons
        run: |
          ABI="${{ matrix.abi }}"
          SO_FILE="dist/android/commons/$ABI/librac_commons.so"
          if [ ! -f "$SO_FILE" ]; then
            echo "::error::Missing $SO_FILE"
            exit 1
          fi
          echo "Build output:"
          ls -lh "dist/android/commons/$ABI/"

  ios:
    name: iOS XCFramework
    runs-on: macos-14
    timeout-minutes: 90
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Xcode
        run: |
          XCODE_PATH="/Applications/Xcode_15.4.app"
          if [ ! -d "$XCODE_PATH" ]; then
            XCODE_PATH="$(ls -d /Applications/Xcode*.app 2>/dev/null | sort -V | tail -1)"
          fi
          sudo xcode-select -s "$XCODE_PATH"
          echo "Using Xcode: $(xcodebuild -version | head -1)"

      - name: Install build tools
        run: brew install cmake ninja

      - name: Build iOS commons
        working-directory: sdk/runanywhere-commons
        run: |
          ./scripts/build-ios.sh --package

      - name: Verify XCFramework
        working-directory: sdk/runanywhere-commons
        run: |
          if [ ! -d "dist/RACommons.xcframework" ]; then
            echo "::error::RACommons.xcframework not found"
            exit 1
          fi
          echo "XCFramework contents:"
          ls -R dist/RACommons.xcframework/ | head -30

  summary:
    name: Build Summary
    runs-on: ubuntu-latest
    if: always()
    needs: [android, ios]
    steps:
      - name: Check results
        run: |
          echo "## Commons C++ Build Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY

          STATUS_ANDROID="${{ needs.android.result }}"
          STATUS_IOS="${{ needs.ios.result }}"

          icon() { if [ "$1" = "success" ]; then echo "pass"; elif [ "$1" = "skipped" ]; then echo "skip"; else echo "FAIL"; fi; }

          echo "| Android (matrix) | $(icon $STATUS_ANDROID) |" >> $GITHUB_STEP_SUMMARY
          echo "| iOS XCFramework | $(icon $STATUS_IOS) |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          FAILED=0
          for status in "$STATUS_ANDROID" "$STATUS_IOS"; do
            if [ "$status" = "failure" ] || [ "$status" = "cancelled" ]; then
              FAILED=1
            fi
          done

          if [ "$FAILED" -eq 1 ]; then
            echo "**One or more jobs failed.** Check the logs above." >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "All jobs passed." >> $GITHUB_STEP_SUMMARY
          fi
